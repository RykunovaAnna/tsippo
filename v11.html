<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Будильник</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
        }
        
        body {
            max-width: 400px;
            margin: 0 auto;
            padding: 0;
            background-color: #f8f9fa;
            color: #212529;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
        
        .screen {
            display: none;
            height: 100%;
            flex-direction: column;
            background: white;
            position: relative;
        }
        
        .active {
            display: flex;
        }
        
        .header {
            padding: 15px 20px;
            font-size: 24px;
            font-weight: 600;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .add-btn {
            
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            border-radius: 50%;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 80px; /* Добавляем отступ для навигации */
        }
        
        .alarm-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
        }
        
        .alarm-info {
            flex: 1;
        }
        
        .alarm-time {
            font-size: 20px;
            font-weight: 700;
        }
        
        .alarm-days {
            font-size: 14px;
            color: #6c757d;
        }
        
        /* Стили для переключателя */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #007bff;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0069d9;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-back {
            background: none;
            border: none;
            padding: 15px;
            font-size: 16px;
            color: #007bff;
            cursor: pointer;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .modal-content {
            background: white;
            width: 80%;
            max-width: 300px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .modal-header {
            padding: 15px;
            font-size: 18px;
            font-weight: 500;
            border-bottom: 1px solid #e9ecef;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            display: flex;
            padding: 15px;
            border-top: 1px solid #e9ecef;
        }
        
        .modal-btn {
            flex: 1;
            margin: 0 5px;
        }
        
        .settings-item {
            padding: 15px 0;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
        
        .active-alarm {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #007bff;
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        
        .active-alarm-time {
            font-size: 48px;
            font-weight: 500;
            margin-bottom: 20px;
        }
        
        .active-alarm-title {
            font-size: 20px;
            margin-bottom: 40px;
        }
        
        .active-alarm-buttons {
            width: 80%;
            max-width: 300px;
        }

        /* Обновленные стили для дней недели */
        .days-container {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            gap: 8px;
        }
        
        .day-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-size: 14px;
            border: 1px solid #e9ecef;
            background-color: transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .day-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        .weekdays-btn {
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            border: 1px solid #e9ecef;
            background-color: transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .weekdays-btn.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        /* Стили для селектора темы */
        .theme-selector {
            display: flex;
            gap: 10px;
        }
        
        .theme-option {
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .theme-option.selected {
            background-color: #007bff;
            color: white;
        }
        
        /* Стили для слайдера громкости */
        .volume-slider {
            width: 100px;
        }
        
        /* Стили для переключателя вибрации */
        .vibration-toggle {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .vibration-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .vibration-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .vibration-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        .vibration-toggle input:checked + .vibration-slider {
            background-color: #007bff;
        }
        
        .vibration-toggle input:checked + .vibration-slider:before {
            transform: translateX(26px);
        }
        
        /* Обновленные стили для нижней навигации */
        .bottom-nav {
            display: flex;
            width: 100%;
            height: 60px;
            background-color: white;
            position: absolute;
            bottom: 0;
            left: 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            z-index: 100;
        }
        
        /* Темная тема для нижней навигации */
        .dark .bottom-nav {
            background-color: #1e1e1e;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
        }
        
        /* Основные стили для навигационных кнопок */
        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            padding: 8px 0;
            position: relative;
        }

        .nav-btn.active {
            color: #007bff;
        }

        .dark .nav-btn.active {
            color: #6ea8fe;
        }

        .nav-btn i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background-color: #007bff;
            transition: width 0.2s;
            border-radius: 3px 3px 0 0;
        }

        .nav-btn.active::after {
            width: 60%;
        }

        .dark .nav-btn::after {
            background-color: #6ea8fe;
        }

        /* Эффект при наведении */
        .nav-btn:hover {
            color: #007bff;
        }

        .dark .nav-btn:hover {
            color: #6ea8fe;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid #007bff;
            color: #007bff;
        }

        .btn-outline:hover {
            background-color: #0573e2;
            color: #ffffff;
        }

        .icon {
            font-size: 16px;
        }

        /* Новые стили для кнопки сохранить в шапке */
        .header-save-btn {
            background-color: transparent;
            color: #007bff;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: color 0.2s;
            padding: 15px;
        }

        .dark .header-save-btn {
            color: #6ea8fe;
        }

        .header-save-btn:hover {
            color: #0056b3;
        }

        .header-title {
            flex-grow: 1;
            text-align: center;
            margin-left: 10px;
        }

        /* Стили для кнопки удаления */
        .delete-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 20px 0 0;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            border: 1px solid #dc3545;
            background-color: transparent;
            color: #dc3545;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background-color: #dc3545;
            color: white;
        }

        /* Темная тема для основного контента */
        .dark .screen {
            background-color: #343a40;
            color: #f8f9fa;
        }

        .dark .header {
            background-color: #343a40;
            border-bottom-color: #495057;
            color: #f8f9fa;
        }

        .dark .content {
            background-color: #343a40;
            color: #f8f9fa;
        }

        .dark .alarm-item {
            border-bottom-color: #495057;
        }

        .dark .alarm-days {
            color: #adb5bd;
        }

        .dark .settings-item {
            border-bottom-color: #495057;
        }

        .dark .modal-content {
            background-color: #343a40;
            color: #f8f9fa;
        }

        .dark .modal-header {
            border-bottom-color: #495057;
        }

        .dark .modal-footer {
            border-top-color: #495057;
        }

        .dark .btn-outline {
            border-color: #6ea8fe;
            color: #6ea8fe;
        }

        .dark .btn-outline:hover {
            background-color: #0d6efd;
            color: white;
        }

        /* Стили для полей ввода в темной теме */
        .dark input[type="time"],
        .dark select {
            background-color: #495057;
            color: #f8f9fa;
            border-color: #6c757d;
        }

        .dark input[type="time"]::-webkit-calendar-picker-indicator,
        .dark select::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>
<body>
    <!-- Главный экран -->
    <div id="main-screen" class="screen active">
        <div class="header">
            <span>Будильник</span>
            <button class="add-btn" onclick="showAddScreen()">+</button>
        </div>
        <div class="content" id="alarms-list">
            <!-- Будильники будут добавляться сюда динамически -->
        </div>
        <div class="bottom-nav">
            <button class="nav-btn active" onclick="showScreen('main-screen')">
                <i class="fas fa-clock"></i>
                <span>Будильники</span>
            </button>
            <button class="nav-btn" onclick="showScreen('settings-screen')">
                <i class="fas fa-cog"></i>
                <span>Настройки</span>
            </button>
        </div>
    </div>
    
    <!-- Экран добавления будильника -->
    <div id="add-screen", class="screen">
        <div class="header">
            <button class="btn-back" onclick="showScreen('main-screen')">Назад</button>
            <span class="header-title">Добавить будильник</span>
            <button class="header-save-btn" onclick="addAlarm()">Сохранить</button>
        </div>
        <div class="content">
            <div style="text-align: center; margin: 20px 0;">
                <input type="time" id="alarm-time-add" style="font-size: 24px; border: 1px solid #e9ecef; border-radius: 5px; padding: 5px;">
            </div>
            
            <div style="margin: 20px 0;">
                <h3 style="margin-bottom: 10px;">Повтор</h3>
                <div class="days-container">
                    <button class="day-btn" data-day="1" onclick="toggleDay(this)">Пн</button>
                    <button class="day-btn" data-day="2" onclick="toggleDay(this)">Вт</button>
                    <button class="day-btn" data-day="3" onclick="toggleDay(this)">Ср</button>
                    <button class="day-btn" data-day="4" onclick="toggleDay(this)">Чт</button>
                    <button class="day-btn" data-day="5" onclick="toggleDay(this)">Пт</button>
                    <button class="day-btn" data-day="6" onclick="toggleDay(this)">Сб</button>
                    <button class="day-btn" data-day="0" onclick="toggleDay(this)">Вс</button>
                </div>
                <div style="margin-top: 10px;">
                    <button class="weekdays-btn" onclick="toggleWeekdays(this)">Будни</button>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <h3 style="margin-bottom: 10px;">Мелодия</h3>
                <select id="alarm-sound-add" style="width: 100%; padding: 10px; border: 1px solid #e9ecef; border-radius: 5px;">
                    <option value="alarm.mp3">Радар</option>
                    <option value="mayak.mp3">Маяк</option>
                    <option value="bell.mp3">Колокольчик</option>
                </select>
            </div>
        </div>
        <div class="bottom-nav">
            <button class="nav-btn" onclick="showScreen('main-screen')">
                <i class="fas fa-clock"></i>
                <span>Будильники</span>
            </button>
            <button class="nav-btn" onclick="showScreen('settings-screen')">
                <i class="fas fa-cog"></i>
                <span>Настройки</span>
            </button>
        </div>
    </div>
    
    <!-- Экран редактирования будильника -->
    <div id="edit-screen", class="screen">
        <div class="header">
            <button class="btn-back" onclick="showScreen('main-screen')">Назад</button>
            <span class="header-title">Редактировать будильник</span>
            <button class="header-save-btn" onclick="saveAlarm()">Сохранить</button>
        </div>
        <div class="content">
            <div style="text-align: center; margin: 20px 0;">
                <input type="time" id="alarm-time-edit" style="font-size: 24px; border: 1px solid #e9ecef; border-radius: 5px; padding: 5px;">
            </div>
            
            <div style="margin: 20px 0;">
                <h3 style="margin-bottom: 10px;">Повтор</h3>
                <div class="days-container">
                    <button class="day-btn" data-day="1" onclick="toggleDay(this)">Пн</button>
                    <button class="day-btn", data-day="2" onclick="toggleDay(this)">Вт</button>
                    <button class="day-btn", data-day="3" onclick="toggleDay(this)">Ср</button>
                    <button class="day-btn", data-day="4" onclick="toggleDay(this)">Чт</button>
                    <button class="day-btn", data-day="5" onclick="toggleDay(this)">Пт</button>
                    <button class="day-btn", data-day="6" onclick="toggleDay(this)">Сб</button>
                    <button class="day-btn", data-day="0" onclick="toggleDay(this)">Вс</button>
                </div>
                <div style="margin-top: 10px;">
                    <button class="weekdays-btn" onclick="toggleWeekdays(this)">Будни</button>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <h3 style="margin-bottom: 10px;">Мелодия</h3>
                <select id="alarm-sound-edit" style="width: 100%; padding: 10px; border: 1px solid #e9ecef; border-radius: 5px;">
                    <option value="alarm.mp3">Радар</option>
                    <option value="mayak.mp3">Маяк</option>
                    <option value="bell.mp3">Колокольчик</option>
                </select>
            </div>
            
            <button class="delete-btn" onclick="showDeleteModal()">Удалить будильник</button>
        </div>
        <div class="bottom-nav">
            <button class="nav-btn" onclick="showScreen('main-screen')">
                <i class="fas fa-clock"></i>
                <span>Будильники</span>
            </button>
            <button class="nav-btn" onclick="showScreen('settings-screen')">
                <i class="fas fa-cog"></i>
                <span>Настройки</span>
            </button>
        </div>
    </div>
    
    <!-- Экран настроек -->
    <div id="settings-screen" class="screen">
        <div class="header">
            <button class="btn-back" onclick="showScreen('main-screen')">Назад</button>
            <span style="margin-left: 10px;">Настройки</span>
        </div>
        <div class="content">
            <div class="settings-item">
                <span>Тема</span>
                <div class="theme-selector">
                    <div class="theme-option selected" onclick="changeTheme('light')">Светлая</div>
                    <div class="theme-option" onclick="changeTheme('dark')">Тёмная</div>
                </div>
            </div>
            <div class="settings-item">
                <span>Формат времени</span>
                <span>24-часовой</span>
            </div>
            <div class="settings-item">
                <span>Громкость</span>
                <input type="range" min="0" max="100" value="80" class="volume-slider" id="volume-slider">
                <span id="volume-value">80%</span>
            </div>
            <div class="settings-item">
                <span>Вибрация</span>
                <label class="vibration-toggle">
                    <input type="checkbox" id="vibration-toggle" checked>
                    <span class="vibration-slider"></span>
                </label>
            </div>
        </div>
        <div class="bottom-nav">
            <button class="nav-btn" onclick="showScreen('main-screen')">
                <i class="fas fa-clock"></i>
                <span>Будильники</span>
            </button>
            <button class="nav-btn active" onclick="showScreen('settings-screen')">
                <i class="fas fa-cog"></i>
                <span>Настройки</span>
            </button>
        </div>
    </div>
    
    <!-- Экран сработавшего будильника -->
    <div id="alarm-active-screen" class="active-alarm">
        <div class="active-alarm-time" id="active-alarm-time-display">06:30</div>
        <div class="active-alarm-title">Будильник</div>
        <div class="active-alarm-buttons">
            <button class="btn" style="background-color: white; color: #007bff; margin-bottom: 10px;" onclick="snoozeAlarm()">Отложить</button>
            <button class="btn" style="background-color: rgba(255,255,255,0.2); color: white;" onclick="stopAlarm()">Стоп</button>
        </div>
        <audio id="alarm-sound" loop>
            <!-- Источник будет установлен динамически -->
        </audio>
    </div>
    
    <!-- Модальное окно подтверждения удаления -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Удалить будильник</div>
            <div class="modal-body">
                Вы уверены, что хотите удалить этот будильник?
            </div>
            <div class="modal-footer">
                <button class="btn-outline modal-btn" onclick="hideDeleteModal()">Отмена</button>
                <button class="btn-danger modal-btn" onclick="deleteAlarm()">Удалить</button>
            </div>
        </div>
    </div>

    <script>
        // Текущий редактируемый будильник
        let currentEditingAlarm = null;
        let alarms = [];
        let alarmCheckInterval = null;
        let currentSettings = {
            theme: 'light',
            volume: 80,
            vibration: true
        };
        
        // Текущий сработавший будильник
        let currentTriggeredAlarmIndex = -1;
        
        // Дни недели для отображения
        const weekDays = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
        
        // Загрузка будильников и настроек при старте
        document.addEventListener('DOMContentLoaded', function() {
            loadAlarms();
            loadSettings();
            renderAlarms();
            initSettingsControls();
            startAlarmCheck();
            
            // Инициализация активного состояния кнопок навигации
            updateNavButtons();
        });
        
        // Обновление активного состояния кнопок навигации
        function updateNavButtons() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen) {
                if (activeScreen.id === 'main-screen') {
                    document.querySelectorAll('.nav-btn')[0].classList.add('active');
                } else if (activeScreen.id === 'settings-screen') {
                    document.querySelectorAll('.nav-btn')[1].classList.add('active');
                }
            }
        }
        
        // Загрузить будильники из localStorage
        function loadAlarms() {
            const savedAlarms = localStorage.getItem('alarms');
            if (savedAlarms) {
                alarms = JSON.parse(savedAlarms);
            }
        }
        
        // Сохранить будильники в localStorage
        function saveAlarms() {
            localStorage.setItem('alarms', JSON.stringify(alarms));
        }
        
        // Загрузить настройки из localStorage
        function loadSettings() {
            const savedSettings = localStorage.getItem('alarmSettings');
            if (savedSettings) {
                currentSettings = JSON.parse(savedSettings);
                applySettings();
            }
        }
        
        // Сохранить настройки в localStorage
        function saveSettings() {
            localStorage.setItem('alarmSettings', JSON.stringify(currentSettings));
        }
        
        // Применить настройки
        function applySettings() {
            // Удаляем предыдущие классы темы
            document.body.classList.remove('dark');
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('dark');
            });
            
            // Применяем новую тему
            if (currentSettings.theme === 'dark') {
                document.body.classList.add('dark');
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.add('dark');
                });
            }
            
            // Обновляем элементы управления
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            const lightOption = document.querySelector('.theme-option:first-child');
            const darkOption = document.querySelector('.theme-option:last-child');
            
            if (currentSettings.theme === 'dark') {
                darkOption.classList.add('selected');
            } else {
                lightOption.classList.add('selected');
            }
            
            document.getElementById('volume-slider').value = currentSettings.volume;
            document.getElementById('volume-value').textContent = `${currentSettings.volume}%`;
            document.getElementById('vibration-toggle').checked = currentSettings.vibration;
        }
        
        // Инициализация элементов управления настройками
        function initSettingsControls() {
            // Громкость
            document.getElementById('volume-slider').addEventListener('input', function() {
                currentSettings.volume = this.value;
                document.getElementById('volume-value').textContent = `${this.value}%`;
                saveSettings();
            });
            
            // Вибрация
            document.getElementById('vibration-toggle').addEventListener('change', function() {
                currentSettings.vibration = this.checked;
                saveSettings();
            });
        }
        
        // Изменение темы
        function changeTheme(theme) {
            currentSettings.theme = theme;
            saveSettings();
            applySettings();
        }
        
        // Отобразить список будильников
        function renderAlarms() {
            const alarmsList = document.getElementById('alarms-list');
            alarmsList.innerHTML = '';
            
            if (alarms.length === 0) {
                alarmsList.innerHTML = '<p style="text-align: center; color: #6c757d;">Нет активных будильников</p>';
                return;
            }
            
            alarms.forEach((alarm, index) => {
                const alarmItem = document.createElement('div');
                alarmItem.className = 'alarm-item';
                
                // Добавляем обработчик клика на весь элемент будильника
                alarmItem.onclick = (e) => {
                    // Проверяем, был ли клик по переключателю
                    if (!e.target.closest('.switch')) {
                        showEditScreen(index);
                    }
                };
                
                // Форматируем дни повторения
                let daysText = '';
                if (alarm.days.length === 7) {
                    daysText = 'Каждый день';
                } else if (alarm.days.length === 5 && 
                          alarm.days.includes(1) && 
                          alarm.days.includes(2) && 
                          alarm.days.includes(3) && 
                          alarm.days.includes(4) && 
                          alarm.days.includes(5)) {
                    daysText = 'По будням';
                } else if (alarm.days.length === 2 && 
                           alarm.days.includes(6) && 
                           alarm.days.includes(0)) {
                    daysText = 'Выходные';
                } else {
                    daysText = alarm.days.map(day => weekDays[day]).join(', ');
                }
                
                alarmItem.innerHTML = `
                    <div class="alarm-info">
                        <div class="alarm-time">${alarm.time}</div>
                        <div class="alarm-days">${daysText}</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" ${alarm.enabled ? 'checked' : ''} onclick="event.stopPropagation(); toggleAlarm(${index}, event)">
                        <span class="slider"></span>
                    </label>
                `;
                
                alarmsList.appendChild(alarmItem);
            });
        }
        
        // Переключить состояние будильника (вкл/выкл)
        function toggleAlarm(index, event) {
            event.stopPropagation(); // Предотвращаем всплытие, чтобы не открывалось редактирование
            alarms[index].enabled = !alarms[index].enabled;
            saveAlarms();
        }
        
        // Показать экран
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            // Обновляем активное состояние кнопок навигации
            updateNavButtons();
        }
        
        // Показать экран добавления будильника
        function showAddScreen() {
            // Сбросить форму
            document.getElementById('alarm-time-add').value = '';
            document.querySelectorAll('#add-screen .day-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('#add-screen .weekdays-btn').classList.remove('active');
            document.getElementById('alarm-sound-add').selectedIndex = 0;
            
            showScreen('add-screen');
        }
        
        // Показать экран редактирования для конкретного будильника
        function showEditScreen(alarmIndex) {
            currentEditingAlarm = alarmIndex;
            const alarm = alarms[alarmIndex];
            
            // Заполнить форму данными будильника
            document.getElementById('alarm-time-edit').value = alarm.time;
            
            // Установить выбранный звук
            const soundSelect = document.getElementById('alarm-sound-edit');
            for (let i = 0; i < soundSelect.options.length; i++) {
                if (soundSelect.options[i].value === alarm.sound) {
                    soundSelect.selectedIndex = i;
                    break;
                }
            }
            
            // Сбросить выделение дней
            document.querySelectorAll('#edit-screen .day-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Выделить выбранные дни
            alarm.days.forEach(day => {
                const btn = document.querySelector(`#edit-screen .day-btn[data-day="${day}"]`);
                if (btn) btn.classList.add('active');
            });
            
            // Проверить "Будни"
            if (alarm.days.length === 5 && 
                alarm.days.includes(1) && 
                alarm.days.includes(2) && 
                alarm.days.includes(3) && 
                alarm.days.includes(4) && 
                alarm.days.includes(5)) {
                document.querySelector('#edit-screen .weekdays-btn').classList.add('active');
            }
            
            showScreen('edit-screen');
        }
        
        // Переключить день в выборе повторения
        function toggleDay(button) {
            button.classList.toggle('active');
        }
        
        // Переключить будни
        function toggleWeekdays(button) {
            button.classList.toggle('active');
            
            const daysContainer = button.closest('div');
            const prevSibling = daysContainer.previousElementSibling;
            const dayButtons = [
                ...daysContainer.querySelectorAll('.day-btn'),
                ...(prevSibling ? prevSibling.querySelectorAll('.day-btn') : []),
                ...(prevSibling && prevSibling.previousElementSibling ? 
                    prevSibling.previousElementSibling.querySelectorAll('.day-btn') : [])
            ];
            
            if (button.classList.contains('active')) {
                // Выделить Пн-Пт
                dayButtons.forEach(btn => {
                    const day = parseInt(btn.getAttribute('data-day'));
                    if (day >= 1 && day <= 5) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            } else {
                // Снять выделение Пн-Пт
                dayButtons.forEach(btn => {
                    const day = parseInt(btn.getAttribute('data-day'));
                    if (day >= 1 && day <= 5) {
                        btn.classList.remove('active');
                    }
                });
            }
        }
        
        // Получить выбранные дни из формы
        function getSelectedDays(screenId) {
            const days = [];
            document.querySelectorAll(`#${screenId} .day-btn.active`).forEach(btn => {
                days.push(parseInt(btn.getAttribute('data-day')));
            });
            return days;
        }
        
        // Добавить новый будильник
        function addAlarm() {
            const time = document.getElementById('alarm-time-add').value;
            const days = getSelectedDays('add-screen');
            const sound = document.getElementById('alarm-sound-add').value;
            
            if (!time) {
                alert('Укажите время будильника');
                return;
            }
            
            if (days.length === 0) {
                alert('Выберите дни повторения');
                return;
            }
            
            alarms.push({
                time,
                days,
                sound,
                enabled: true
            });
            
            saveAlarms();
            renderAlarms();
            showScreen('main-screen');
        }
        
        // Сохранить изменения в будильнике
        function saveAlarm() {
            const time = document.getElementById('alarm-time-edit').value;
            const days = getSelectedDays('edit-screen');
            const sound = document.getElementById('alarm-sound-edit').value;
            
            if (!time) {
                alert('Укажите время будильника');
                return;
            }
            
            if (days.length === 0) {
                alert('Выберите дни повторения');
                return;
            }
            
            // Сохраняем предыдущее состояние enabled
            const wasEnabled = alarms[currentEditingAlarm].enabled;
            
            alarms[currentEditingAlarm] = {
                time,
                days,
                sound,
                enabled: wasEnabled
            };
            
            saveAlarms();
            renderAlarms();
            showScreen('main-screen');
        }
        
        // Показать модальное окно удаления
        function showDeleteModal() {
            document.getElementById('delete-modal').style.display = 'flex';
        }
        
        // Скрыть модальное окно удаления
        function hideDeleteModal() {
            document.getElementById('delete-modal').style.display = 'none';
        }
        
        // Удалить будильник
        function deleteAlarm() {
            alarms.splice(currentEditingAlarm, 1);
            saveAlarms();
            renderAlarms();
            hideDeleteModal();
            showScreen('main-screen');
        }
        
        // Отложить будильник
        function snoozeAlarm() {
            document.getElementById('alarm-sound').pause();
            document.getElementById('alarm-active-screen').style.display = 'none';
            
            // Отключаем текущий сработавший будильник
            if (currentTriggeredAlarmIndex !== -1) {
                alarms[currentTriggeredAlarmIndex].enabled = false;
                saveAlarms();
                renderAlarms();
            }
            
            currentTriggeredAlarmIndex = -1;
            
            // Установим будильник на 5 минут позже
            const now = new Date();
            now.setMinutes(now.getMinutes() + 5);
            
            const snoozeTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            // Используем тот же звук, что и у оригинального будильника
            const originalAlarm = alarms[currentTriggeredAlarmIndex];
            const sound = originalAlarm ? originalAlarm.sound : 'alarm.mp3';
            
            alarms.push({
                time: snoozeTime,
                days: [now.getDay()],
                sound: sound,
                enabled: true,
                isSnooze: true
            });
            
            saveAlarms();
            renderAlarms();
        }
        
        // Остановить будильник
        function stopAlarm() {
            const alarmSound = document.getElementById('alarm-sound');
            alarmSound.pause();
            document.getElementById('alarm-active-screen').style.display = 'none';
            
            // Отключаем текущий сработавший будильник
            if (currentTriggeredAlarmIndex !== -1) {
                alarms[currentTriggeredAlarmIndex].enabled = false;
                saveAlarms();
                renderAlarms();
            }
            
            // Останавливаем вибрацию
            if ('vibrate' in navigator) {
                navigator.vibrate(0);
            }
            
            currentTriggeredAlarmIndex = -1;
        }
        
        // Начать проверку срабатывания будильников
        function startAlarmCheck() {
            if (alarmCheckInterval) {
                clearInterval(alarmCheckInterval);
            }
            
            alarmCheckInterval = setInterval(checkAlarms, 1000);
        }
        
        // Проверить, нужно ли срабатывать будильникам
        function checkAlarms() {
            const now = new Date();
            const currentDay = now.getDay(); // 0 - воскресенье, 1 - понедельник и т.д.
            const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            alarms.forEach((alarm, index) => {
                if (!alarm.enabled) return;
                
                // Проверяем, должен ли сработать будильник
                if (alarm.time === currentTime && 
                    (alarm.days.includes(currentDay) || alarm.isSnooze)) {
                    
                    // Запоминаем индекс сработавшего будильника
                    currentTriggeredAlarmIndex = index;
                    
                    // Если это будильник "отложенный", удаляем его после срабатывания
                    if (alarm.isSnooze) {
                        const index = alarms.findIndex(a => a.isSnooze);
                        if (index !== -1) {
                            alarms.splice(index, 1);
                            saveAlarms();
                            renderAlarms();
                        }
                    }
                    
                    // Запускаем будильник
                    triggerAlarm(alarm);
                }
            });
        }
        
        // Срабатывание будильника
        function triggerAlarm(alarm) {
            document.getElementById('active-alarm-time-display').textContent = alarm.time;
            document.getElementById('alarm-active-screen').style.display = 'flex';
            
            // Получаем элемент audio
            const alarmSound = document.getElementById('alarm-sound');
            
            // Устанавливаем источник звука в зависимости от выбранного будильника
            alarmSound.src = `sounds/${alarm.sound}`;
            
            try {
                // Сбрасываем позицию воспроизведения
                alarmSound.currentTime = 0;
                
                // Устанавливаем громкость
                alarmSound.volume = currentSettings.volume / 100;
                
                // Пытаемся воспроизвести
                const playPromise = alarmSound.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.error('Ошибка воспроизведения:', error);
                        // Показываем кнопку для ручного запуска звука
                        alert('Нажмите OK для воспроизведения звука будильника');
                        alarmSound.play().catch(e => console.error('Повторная ошибка:', e));
                    });
                }
            } catch (error) {
                console.error('Ошибка при воспроизведении звука:', error);
            }
            
            // Вибрация, если включена
            if (currentSettings.vibration && 'vibrate' in navigator) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
        }
        
        // Полифил для :contains()
        if (!('contains' in Element.prototype)) {
            Element.prototype.contains = function(arg) {
                return this.querySelector(':scope ' + arg) !== null;
            };
        }
    </script>
</body>
</html>